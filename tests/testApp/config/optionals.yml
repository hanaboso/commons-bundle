parameters:
    database_type: 'ODM'

services:
    _defaults:
        public: '%public.services%'

    # Handlers
    hbpf.commons.session_handler:
        class: Hanaboso\CommonsBundle\Session\Handler\CachedSessionHandler
        arguments:
            - '@hbpf.commons.redis_session_handler'

    hbpf.commons.redis_session_handler:
        class: Hanaboso\CommonsBundle\Session\Handler\RedisSessionHandler
        arguments:
            - '@snc_redis.sessions'

    hbpf.system_metrics_listener:
        class: Hanaboso\CommonsBundle\Listener\SystemMetricsListener
        arguments:
            - '@hbpf.influxdb_sender'
        calls:
            - ['setLogger', ['@monolog.logger.commons']]
        tags:
            - { name: kernel.event_subscriber, event: kernel.terminate }
            - { name: kernel.event_subscriber, event: kernel.controller }

    hbpf.file_storage.driver.mongo:
        class: Hanaboso\CommonsBundle\FileStorage\Driver\MongoFileDriver
        arguments:
            - '@doctrine_mongodb.odm.default_document_manager'
            - '@hbpf.path_generator.hash'

    hbpf.path_generator.hash:
        class: Hanaboso\CommonsBundle\FileStorage\PathGenerator\HashPathGenerator
        arguments:

    hbpf.file_storage.locator:
        class: Hanaboso\CommonsBundle\FileStorage\Driver\FileStorageDriverLocator
        arguments:
            - '@hbpf.file_storage.driver.mongo'
            - '@hbpf.file_storage.driver.mongo'
            - '@hbpf.file_storage.driver.mongo'

    hbpf.file_storage:
        class: Hanaboso\CommonsBundle\FileStorage\FileStorage
        arguments:
            - '@hbpf.file_storage.locator'
            - '@hbpf.database_manager_locator'
            - 'Hanaboso\CommonsBundle\FileStorage\Document\File'

    hbpf.database_manager_locator:
        class: Hanaboso\CommonsBundle\DatabaseManager\DatabaseManagerLocator
        arguments:
            - '@doctrine_mongodb.odm.default_document_manager'
            - null
            - '%database_type%'

    udp_metrics_sender:
        class: Hanaboso\CommonsBundle\Metrics\UDPSender
        arguments:
            - '%influx.host%'
            - '%influx.udp_port%'
        calls:
            - ['setLogger', ['@monolog.logger.commons']]

    hbpf.influxdb_sender:
        class: Hanaboso\CommonsBundle\Metrics\InfluxDbSender
        arguments:
            - '@udp_metrics_sender'
            - '%influx.fpm_table%'

    hbpf.docker.handler.docker_handler:
        class: Hanaboso\CommonsBundle\Docker\Handler\DockerHandler
        arguments: ['@hbpf.docker.docker']

    hbpf.docker.docker:
        class: Hanaboso\CommonsBundle\Docker\Docker
        arguments: ['@hbpf.commons.docker.docker_client']

    hbpf.commons.docker.docker_client:
        class: Hanaboso\CommonsBundle\Docker\DockerClient
        arguments:
            - '%docker.connection.settings%'